formatVersion: 1
inputs:
  NbreNode:
    title: Nombre de kubernetes nodes
    type: integer
    default: 2
    minimum: 1
    maximum: 4
  rootPasswd:
    description: Password root (deja configuré dans le template) de la VM master K8S.
    title: Password configuré
    type: string
    encrypted: true
  RangeIP:
    type: string
    description: Range IP qui sera utilisé dans Kubernetes avec le mode de service de type LoadBalancer
    title: IP range
    default: 172.19.2.226-172.19.2.239
resources:
  K8S_Master:
    type: Cloud.Machine
    metadata:
      layoutPosition:
        - 0
        - 1
    properties:
      image: CentOS
      flavor: Medium # 2 vCPU
      resourceGroupName: From_vRA8
      customizationSpec: Linux
      networks:
        - network: '${resource.Cloud_Network.id}'
          assignment: static
      cloudConfig: |
        #cloud-config
        runcmd:
          - touch /etc/cloud/cloud-init.disabled
          - cd /tmp
          - yum install -y git
          - git clone https://github.com/ahugla/CAS_vRA8.git
          - cp /tmp/CAS_vRA8/blueprints/Kubernetes/K8S-prepare.sh /tmp/K8S-prepare.sh
          - cp /tmp/CAS_vRA8/blueprints/Kubernetes/K8S-MasterConfig.sh /tmp/K8S-MasterConfig.sh
          - chmod 755 K8S-prepare.sh K8S-MasterConfig.sh
          - /tmp/K8S-prepare.sh
          - /tmp/K8S-MasterConfig.sh ${input.RangeIP}
          - rm -f K8S-prepare.sh
          - rm -f K8S-MasterConfig.sh
  K8S_Nodes:
    type: Cloud.Machine
    metadata:
      layoutPosition:
        - 0
        - 2
    properties:
      image: CentOS
      flavor: Medium # 2 vCPU
      count: '${input.NbreNode}'
      resourceGroupName: From_vRA8
      customizationSpec: Linux
      networks:
        - network: '${resource.Cloud_Network.id}'
          assignment: static
      cloudConfig: |
        #cloud-config
        runcmd:
          - touch /etc/cloud/cloud-init.disabled    # evite d'executer cloud-init au reboot
          - echo "resource.K8S_Master.address = " ${resource.K8S_Master.address}                          # Recupere souvent l'IP flannel =>  NO OK
          - echo "resource.K8S_Master.networks.address = " ${resource.K8S_Master.networks.address}        # Tableau des IPs des vnics  =>  NO OK
          - echo "resource.K8S_Master.networks.address[0] = " ${resource.K8S_Master.networks.address[0]}  # Premiere IP  =>  OK
          - cd /tmp
          - yum install -y git
          - git clone https://github.com/ahugla/CAS_vRA8.git
          - cp /tmp/CAS_vRA8/blueprints/Kubernetes/K8S-prepare.sh /tmp/K8S-prepare.sh
          - cp /tmp/CAS_vRA8/blueprints/Kubernetes/K8S-JoinCluster.sh /tmp/K8S-JoinCluster.sh
          - chmod 755 K8S-prepare.sh K8S-JoinCluster.sh
          - /tmp/K8S-prepare.sh
          - /tmp/K8S-JoinCluster.sh ${resource.K8S_Master.networks.address[0]}  ${input.rootPasswd}
          - rm -f K8S-prepare.sh
          - rm -f K8S-JoinCluster.sh
  Cloud_Network:
    type: Cloud.Network
    metadata:
      layoutPosition:
        - 1
        - 0
    properties:
      networkType: existing
      constraints:
        - tag: 'netprofile:nsx'
